# 媒体库与图片详情

## 背景与使用场景
- Hexo 站点的静态资源会通过 HexoAgent 暴露为资产列表，但此前客户端仅支持通过文件管理器或命令行手动查看与清理。
- 运营在撰写与排版文章时，需要快速浏览媒体资源、识别重复尺寸的图片变体，并在必要时删除冗余文件。
- 文章编辑器引用的封面或配图通常以多尺寸格式存在，缺乏一个集中界面来查看同名图片的全部版本。

## 目标概述
1. **媒体库总览**：提供应用内的媒体库列表页（`MediaLibraryView`），以标签页区分“图片”和“文件”两类资产，支撑预览与基础信息浏览。
2. **图片分组与导航**：对可预览图片按文件夹 + 归一化文件名分组，卡片式展示代表图、变体数量，并可跳转至详情页。
3. **删除操作**：允许对可删除格式（`.png`、`.jpg`、`.jpeg`、`.webp`、`.gif`、`.svg`）执行删除操作，提供确认弹窗、执行态提示与成功反馈。
4. **详情页补充信息**：在 `MediaDetailView` 中展示单个图片分组的详细信息、主图预览、文件系统元数据、引用情况与变体列表，并支持在该页面继续删除单个变体。

## 功能与验收细项
- 媒体库页顶部展示标题“媒体库”，下方以 `ElTabs` 区分“图片”和“文件”两个标签页，默认进入“图片”页签。
- 进入页面后调用 `window.site.getAssets()` 拉取最新资产列表；删除成功后自动重新拉取数据并刷新 UI。
- **图片页签**：
  - 使用 `buildImageGroups` 根据文件路径与扩展名（`.png`、`.jpg`、`.jpeg`、`.gif`、`.svg`、`.webp`）分组，移除文件名中的 `-WxH`（如 `banner-800x400`）后作为同组识别依据。
  - 以网格卡片展示，每张卡片包含代表图预览、文件显示名以及“共 X 个变体”元信息；点击卡片跳转至名为 `media-detail` 的路由，并传入编码后的分组 key。
  - 当无可预览图片时，展示空态组件，文案为“暂无图片”。
- **文件页签**：
  - 显示所有非预览资产的表格，列含 `id`、`path`、`modified`、`renderable`、`source` 等字段。
  - 对表格中符合删除格式的资产展示“删除”链接按钮，点击后弹出确认框，确认后调用 `window.site.deleteAsset(asset.id)` 并在成功时提示“删除成功”。
  - 当无文件类资产时，展示空态组件，文案为“暂无文件”。
- 删除确认弹窗需包含“确认删除该资源吗？”等警示文案，并提供确定/取消按钮；删除过程中按钮进入 Loading 状态并被禁用，避免重复提交。
- 资产预览链接统一拼接 `http://127.0.0.1:2357/` 为资源根路径，确保图片在卡片与详情页内可直接加载。

### 图片详情页
- 路由命名：`media-detail`，参数 `groupKey` 为图片组 key，经 `encodeURIComponent` 传递。
- 页面顶部由标题“图片：{图片组名}”与右侧“返回列表”按钮构成；返回按钮复用分类详情页的样式与布局。
- 若拉取到的分组中不存在该 `groupKey`，自动返回媒体库列表；当数据尚未加载完毕时保留当前页，避免闪屏。
- 展示内容包含：
  - 代表图大图预览区域。
  - 文件系统元信息：文件大小（自动换算为 KB/MB）、图片像素尺寸、创建/更新时间，以及“在浏览器打开”链接。
  - 变体列表表格，内含小图预览、文件路径、文件大小、像素尺寸，以及操作列。
    - 操作列提供“打开”“查看引用”“删除”三个链接式按钮。
    - 选择“查看引用”时弹出引用列表对话框，列出所有引用该图片的文章标题与源文件路径；无引用时可在对话框中直接点击“删除此图片”，触发二次确认后删除原图。
  - 对可删除格式提供删除按钮，流程与总览页一致，并在删除后刷新资产列表。
- 当分组为空或无匹配记录时，展示空态与“返回列表”按钮。

## 范围之外
- 不新增文件上传、批量删除、重命名等高级操作。
- 删除支持的格式仅限 `.png`、`.jpg`、`.jpeg`、`.webp`、`.gif`、`.svg`，其余格式保持只读。
- 针对图片引用提供只读的引用列表，仅支持查看与在空引用场景下快捷删除；不涉及自动修改文章内容。
- 不支持在客户端内配置媒体根路径，默认使用本地 Hexo 静态资源服务地址。

## 技术/实施提示
- 分组与预览逻辑共用 `@/utils/media` 中的 `buildImageGroups`；必要时可扩展该工具以支持更多归一化规则。
- 删除操作需在前端维护一个 `deletingState` 映射，用于标记各资产的删除进行中状态，并在完成后移除标记。
- 详情页依赖 `watchEffect` 监听资产和路由参数，若目标分组不存在则通过 `router.replace({ name: 'media-library' })` 回退，避免残留 404 状态。
- 文件大小、创建/更新时间通过主进程的 `FsAgent.getFileInfo` 提供，避免 CSP / CORS 限制；图片尺寸则在渲染端加载 Image 对象获取。
- 图片引用检索复用 `FsAgent.findAssetReferences`，按 `_posts` 目录遍历匹配；引用列表需缓存文章元数据（`window.site.getPosts(true, true, -1, 0)`），避免重复拉取。
- 所有网络或 IPC 调用失败时，需通过 `ElMessage.error` 提示错误信息，并包含原始错误内容便于排查。
- 图片预览尺寸受 `media-card` 与 `media-detail-card` 样式限制，可按需调节，但须保证长宽自适应且不变形。

## 测试建议
- **手动测试**：
  - 切换“图片”“文件”页签确保数据正确分流，空态文案符合预期。
  - 验证图片分组：同一目录下存在 `banner.png`、`banner-800x400.png` 时，应聚合为一个卡片，变体数为 2。
  - 点击卡片进入详情页，确认标题、文件大小、像素尺寸、创建/更新时间展示正确；删除任一变体后，页面刷新并更新变体数，若删完应跳回总览。
  - 在“查看引用”对话框中验证有/无引用两种情况：无引用时可直接删除图片且对话框自动关闭；有引用时列表内容需可跳转至文章编辑器。
  - 在文件页删除支持格式的资源，观察按钮 Loading 与成功/失败提示。
  - 模拟无效 `groupKey` 访问（手动修改地址），应自动回退到媒体库列表。
- **自动化测试**（如有测试框架）：
  - 针对 `buildImageGroups` 编写单元测试，覆盖变体归并、代表图选取、排序等逻辑。
  - 为视图组件补充渲染测试，验证删除按钮的禁用状态与确认流程，以及引用对话框内的快捷删除逻辑。
  - 对路由守卫或 `watchEffect` 行为进行集成测试，确保非法参数会重定向。
  - 针对 `FsAgent` 的文件元信息和引用检索编写单测，覆盖前导斜杠、不同扩展名、目录遍历等场景。
- **回归测试**：
  - 执行 `npm run lint`、`npm run test`（如存在）确认变更未破坏既有功能。
  - 重点关注与资源管理相关的 IPC 通道，确认删除后 Hexo 缓存已同步刷新。
